<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pháo Thủ Toán Học</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; user-select: none; }
        
        /* UI Lớp phủ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        .hud-top { display: flex; justify-content: space-between; padding: 20px; font-size: 1.5rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .score-box { color: #fbbf24; }
        .lives-box { color: #ef4444; }

        /* Bảng câu hỏi */
        #question-board {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95); border: 2px solid #3b82f6;
            padding: 15px 40px; border-radius: 15px; min-width: 300px; text-align: center;
            font-size: 1.5rem; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transition: transform 0.3s;
        }

        /* Màn hình Start / Game Over */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); pointer-events: auto; z-index: 20;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .modal h1 { font-size: 4rem; margin: 0; color: #3b82f6; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 30px #3b82f6; text-align: center; }
        .modal p { font-size: 1.5rem; color: #cbd5e1; margin-bottom: 40px; text-align: center; max-width: 600px; }
        
        .btn {
            padding: 15px 50px; font-size: 2rem; background: linear-gradient(45deg, #2563eb, #ec4899);
            border: none; border-radius: 50px; color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.6); transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.1); }
        .hidden { display: none !important; }

        /* Canvas nền */
        canvas { display: block; background: #020617 url('https://img.freepik.com/free-vector/space-background-with-stars-nebula_189057-238.jpg') center/cover; }

        /* Hiệu ứng nổ */
        .explosion { position: absolute; width: 120px; height: 120px; pointer-events: none; animation: boom 0.5s forwards; background: radial-gradient(circle, #facc15, #ef4444, transparent); border-radius: 50%; opacity: 0; transform: translate(-50%, -50%); }
        @keyframes boom { 0% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
        
        /* Thiên thạch đáp án */
        .falling-item {
            position: absolute; background: white; color: black;
            padding: 15px 20px; border-radius: 50%; font-weight: bold;
            box-shadow: 0 0 15px rgba(255,255,255,0.6);
            transform: translate(-50%, -50%);
            white-space: nowrap; pointer-events: auto; cursor: crosshair;
            border: 4px solid #64748b; font-size: 1.3rem;
            min-width: 70px; min-height: 70px; display: flex; justify-content: center; align-items: center;
        }
        .falling-item:hover { border-color: #ef4444; background: #fee2e2; }

        #damage-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 15; }
    </style>
</head>
<body>

    <div id="damage-overlay"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="score-box">ĐIỂM: <span id="score">0</span></div>
            <div class="lives-box">MẠNG: <span id="lives">3</span></div>
        </div>
        
        <div id="question-board">
            Đang tải dữ liệu...
        </div>

        <div id="meteors-container"></div>
    </div>

    <div id="start-screen" class="modal">
        <h1>Math Defender</h1>
        <p>Phiên bản: <strong>3 MẠNG</strong><br>Bắn vào thiên thạch chứa ĐÁP ÁN ĐÚNG.</p>
        <button class="btn" onclick="startGame()">BẮT ĐẦU</button>
    </div>

    <div id="game-over-screen" class="modal hidden">
        <h1 style="color: #ef4444;">GAME OVER</h1>
        <p>Tổng điểm: <span id="final-score" style="color: yellow; font-weight: bold; font-size: 3rem;">0</span></p>
        <button class="btn" onclick="startGame()">CHƠI LẠI</button>
    </div>

<script>
    // --- NGÂN HÀNG CÂU HỎI ---
    const questionBank = [
        { q: "$$\\frac{x}{5} + \\frac{2x}{5}$$", a: "$$\\frac{3x}{5}$$", d: ["$$3x$$", "$$\\frac{x}{5}$$", "$$\\frac{3x}{10}$$"] },
        { q: "$$\\frac{4x-1}{2} - \\frac{2x-1}{2}$$", a: "$$x$$", d: ["$$2x$$", "$$x-1$$", "$$1$$"] },
        { q: "$$\\frac{x^2}{x-2} - \\frac{4}{x-2}$$", a: "$$x+2$$", d: ["$$x-2$$", "$$x$$", "$$x^2-4$$"] },
        { q: "$$\\frac{3x+1}{x+1} - \\frac{2x}{x+1}$$", a: "$$1$$", d: ["$$x$$", "$$\\frac{x}{x+1}$$", "$$0$$"] },
        { q: "$$\\frac{2}{x} + \\frac{3}{x} - \\frac{1}{x}$$", a: "$$\\frac{4}{x}$$", d: ["$$4$$", "$$\\frac{5}{x}$$", "$$\\frac{4}{3x}$$"] },
        { q: "$$\\frac{2}{x-1} + \\frac{2}{1-x}$$", a: "$$0$$", d: ["$$4$$", "$$\\frac{4}{x-1}$$", "$$1$$"] },
        { q: "$$\\frac{x}{x-y} - \\frac{y}{x-y}$$", a: "$$1$$", d: ["$$x-y$$", "$$-1$$", "$$0$$"] },
        { q: "$$\\frac{3}{2x-2} + \\frac{1}{1-x}$$", a: "$$\\frac{1}{2(x-1)}$$", d: ["$$\\frac{2}{x-1}$$", "$$1$$", "$$\\frac{5}{2x-2}$$"] },
        { q: "$$\\frac{x-2}{x-3} - \\frac{1}{3-x}$$", a: "$$1$$", d: ["$$\\frac{x-3}{x+3}$$", "$$0$$", "$$\\frac{x-1}{x-3}$$"] },
        { q: "$$\\frac{1}{x} + \\frac{1}{2x}$$", a: "$$\\frac{3}{2x}$$", d: ["$$\\frac{2}{3x}$$", "$$\\frac{2}{x}$$", "$$\\frac{1}{2x^2}$$"] },
        { q: "$$\\frac{1}{x} - \\frac{1}{y}$$", a: "$$\\frac{y-x}{xy}$$", d: ["$$\\frac{x-y}{xy}$$", "$$0$$", "$$\\frac{1}{x-y}$$"] },
        { q: "$$2 + \\frac{3}{x}$$", a: "$$\\frac{2x+3}{x}$$", d: ["$$\\frac{5}{x}$$", "$$2x+3$$", "$$\\frac{6}{x}$$"] },
        { q: "$$\\frac{x}{y} + \\frac{y}{x}$$", a: "$$\\frac{x^2+y^2}{xy}$$", d: ["$$1$$", "$$\\frac{x+y}{xy}$$", "$$2$$"] },
        { q: "$$\\frac{3}{4x} - \\frac{1}{2x}$$", a: "$$\\frac{1}{4x}$$", d: ["$$\\frac{2}{2x}$$", "$$\\frac{1}{2x}$$", "$$\\frac{3}{2x}$$"] },
        { q: "$$\\frac{1}{x} - \\frac{1}{x+1}$$", a: "$$\\frac{1}{x(x+1)}$$", d: ["$$1$$", "$$\\frac{2x+1}{x(x+1)}$$", "$$\\frac{-1}{x(x+1)}$$"] },
        { q: "$$\\frac{x}{x-1} - 1$$", a: "$$\\frac{1}{x-1}$$", d: ["$$x-1$$", "$$\\frac{-1}{x-1}$$", "$$1$$"] },
        { q: "$$\\frac{2x}{x^2-1} - \\frac{1}{x-1}$$", a: "$$\\frac{1}{x+1}$$", d: ["$$\\frac{1}{x-1}$$", "$$\\frac{3x}{x^2-1}$$", "$$1$$"] },
        { q: "$$\\frac{1}{x+2} + \\frac{1}{x-2}$$", a: "$$\\frac{2x}{x^2-4}$$", d: ["$$\\frac{2}{x^2-4}$$", "$$\\frac{2}{2x}$$", "$$0$$"] },
        { q: "$$\\frac{3}{x+1} - \\frac{3x}{x^2-1}$$", a: "$$\\frac{-3}{x^2-1}$$", d: ["$$0$$", "$$\\frac{3}{x-1}$$", "$$\\frac{3(x-2)}{x^2-1}$$"] },
        { q: "$$\\frac{5}{2x} + \\frac{1}{x+1}$$", a: "$$\\frac{7x+5}{2x(x+1)}$$", d: ["$$\\frac{6}{3x+1}$$", "$$\\frac{5x+1}{2x^2}$$", "$$1$$"] }
    ];

    // --- CẤU HÌNH GAME ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const meteorsContainer = document.getElementById('meteors-container');
    
    let gameState = {
        score: 0,
        lives: 3,
        isRunning: false,
        currentQ: null,
        meteors: [], 
        bullets: [],
        meteorSpeed: 0.5, // TỐC ĐỘ BAN ĐẦU 
        cannonAngle: 0
    };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- LOGIC GAME ---
    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        
        gameState.score = 0;
        gameState.lives = 3;
        // --- THAY ĐỔI 1: Tốc độ khởi điểm chậm (0.5 thay vì 1.5) ---
        gameState.meteorSpeed = 0.5; 
        gameState.isRunning = true;
        gameState.bullets = [];
        
        updateHUD();
        nextTurn();
        gameLoop();
    }

    function nextTurn() {
        meteorsContainer.innerHTML = '';
        gameState.meteors = [];

        const qData = questionBank[Math.floor(Math.random() * questionBank.length)];
        gameState.currentQ = qData;
        
        const board = document.getElementById('question-board');
        board.innerHTML = qData.q;
        MathJax.typesetPromise([board]);

        let answers = [
            { val: qData.a, isCorrect: true },
            { val: qData.d[0], isCorrect: false },
            { val: qData.d[1], isCorrect: false }
        ];
        answers.sort(() => Math.random() - 0.5);

        const sectionWidth = canvas.width / 3;
        answers.forEach((ans, index) => {
            spawnMeteor(ans, index * sectionWidth + sectionWidth/2);
        });
    }

    function spawnMeteor(ansData, xPos) {
        const el = document.createElement('div');
        el.className = 'falling-item';
        el.innerHTML = ansData.val;
        
        const randomOffset = (Math.random() - 0.5) * 100; 
        const startX = Math.max(80, Math.min(canvas.width - 80, xPos + randomOffset));
        
        el.style.left = startX + 'px';
        el.style.top = '-80px'; 
        
        meteorsContainer.appendChild(el);
        
        gameState.meteors.push({
            el: el,
            x: startX,
            y: -80,
            isCorrect: ansData.isCorrect,
            active: true
        });

        MathJax.typesetPromise([el]);
    }

    window.addEventListener('mousemove', (e) => {
        const dx = e.clientX - canvas.width / 2;
        const dy = e.clientY - canvas.height;
        gameState.cannonAngle = Math.atan2(dy, dx);
    });

    window.addEventListener('click', (e) => {
        if (!gameState.isRunning) return;
        shootBullet();
    });

    function shootBullet() {
        const startX = canvas.width / 2;
        const startY = canvas.height - 40;
        const angle = gameState.cannonAngle;
        const speed = 20;

        gameState.bullets.push({
            x: startX,
            y: startY,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            active: true
        });
    }

    function gameLoop() {
        if (!gameState.isRunning) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawCannon();
        updateBullets();
        updateMeteors();

        requestAnimationFrame(gameLoop);
    }

    function drawCannon() {
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height); 
        ctx.rotate(gameState.cannonAngle + Math.PI / 2);
        
        ctx.fillStyle = '#3b82f6';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#3b82f6';
        ctx.fillRect(-20, -100, 40, 100);
        
        ctx.beginPath();
        ctx.arc(0, 0, 50, 0, Math.PI * 2);
        ctx.fillStyle = '#1e293b';
        ctx.fill();
        
        ctx.restore();
    }

    function updateBullets() {
        ctx.fillStyle = '#fbbf24';
        ctx.shadowBlur = 20; 
        ctx.shadowColor = '#fbbf24';

        gameState.bullets.forEach(b => {
            if (!b.active) return;
            b.x += b.vx;
            b.y += b.vy;
            
            ctx.beginPath();
            ctx.arc(b.x, b.y, 20, 0, Math.PI * 2); // Đạn lớn
            ctx.fill();

            if (b.x < 0 || b.x > canvas.width || b.y < 0) b.active = false;
            checkCollision(b);
        });
    }

    function updateMeteors() {
        let activeCount = 0;

        gameState.meteors.forEach(m => {
            if (!m.active) {
                m.el.style.display = 'none';
                return;
            }
            activeCount++;

            m.y += gameState.meteorSpeed;
            m.el.style.top = m.y + 'px';

            if (m.y > canvas.height) {
                m.active = false;
                if (m.isCorrect) loseLife();
            }
        });

        if (activeCount === 0 && gameState.meteors.length > 0) {
            setTimeout(nextTurn, 1000);
        }
    }

    function checkCollision(bullet) {
        const bulletRadius = 20;

        gameState.meteors.forEach(m => {
            if (!m.active) return;

            const rect = m.el.getBoundingClientRect();
            
            if (bullet.x >= rect.left - bulletRadius && 
                bullet.x <= rect.right + bulletRadius &&
                bullet.y >= rect.top - bulletRadius && 
                bullet.y <= rect.bottom + bulletRadius) {
                
                bullet.active = false;
                createExplosion(m.x, m.y);
                m.active = false; 
                
                if (m.isCorrect) {
                    gameState.score += 100;
                    // --- THAY ĐỔI 2: Tăng tốc chậm (0.1 thay vì 0.2) ---
                    gameState.meteorSpeed += 0.1; 
                    updateHUD();
                    gameState.meteors.forEach(other => other.active = false);
                } else {
                    loseLife();
                }
            }
        });
    }

    function loseLife() {
        gameState.lives--;
        updateHUD();
        const overlay = document.getElementById('damage-overlay');
        overlay.style.opacity = 0.5;
        setTimeout(() => overlay.style.opacity = 0, 200);

        if (gameState.lives <= 0) gameOver();
    }

    function updateHUD() {
        document.getElementById('score').innerText = gameState.score;
        document.getElementById('lives').innerText = gameState.lives;
    }

    function createExplosion(x, y) {
        const exp = document.createElement('div');
        exp.className = 'explosion';
        exp.style.left = x + 'px';
        exp.style.top = y + 'px';
        document.body.appendChild(exp);
        setTimeout(() => exp.remove(), 500);
    }

    function gameOver() {
        gameState.isRunning = false;
        document.getElementById('final-score').innerText = gameState.score;
        document.getElementById('game-over-screen').classList.remove('hidden');
    }
</script>
</body>
</html>
