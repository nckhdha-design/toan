<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Survivor - RPG Battle</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --primary: #7c3aed; --danger: #ef4444; --success: #10b981; --bg: #1e1b4b; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; overflow: hidden; }
        
        /* Layout ch√≠nh */
        .game-container { width: 900px; height: 600px; background: url('https://img.freepik.com/free-vector/dark-cave-landscape_1308-16279.jpg?w=1380') no-repeat center center; background-size: cover; position: relative; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; }
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 1; }
        
        /* SETUP SCREEN */
        #setup-screen { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(17, 24, 39, 0.95); }
        input, select { padding: 12px; margin: 10px; width: 300px; border-radius: 8px; border: none; font-size: 1rem; }
        .btn-start { padding: 15px 40px; background: var(--primary); color: white; border: none; font-size: 1.5rem; font-weight: bold; cursor: pointer; border-radius: 50px; margin-top: 20px; transition: 0.3s; box-shadow: 0 0 20px var(--primary); }
        .btn-start:hover { transform: scale(1.1); }

        /* BATTLE ARENA */
        #battle-screen { position: absolute; z-index: 5; width: 100%; height: 100%; display: none; }
        
        /* Nh√¢n v·∫≠t */
        .character { position: absolute; bottom: 180px; transition: transform 0.2s; }
        #hero { left: 100px; font-size: 8rem; filter: drop-shadow(0 0 10px blue); }
        #monster { right: 100px; font-size: 10rem; filter: drop-shadow(0 0 10px red); transition: filter 0.2s; }
        
        /* Health Bars */
        .hp-container { position: absolute; width: 250px; padding: 10px; background: rgba(0,0,0,0.7); border-radius: 10px; border: 2px solid #555; }
        .hp-bar { height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .hp-fill { height: 100%; transition: width 0.5s ease-out; }
        #hero-hp-box { top: 20px; left: 20px; }
        #hero-hp-fill { background: var(--success); width: 100%; }
        #monster-hp-box { top: 20px; right: 20px; text-align: right; }
        #monster-hp-fill { background: var(--danger); width: 100%; }

        /* Khu v·ª±c c√¢u h·ªèi (UI ch√≠nh) */
        .combat-ui { position: absolute; bottom: 0; width: 100%; height: 220px; background: rgba(15, 23, 42, 0.95); border-top: 4px solid var(--primary); display: flex; flex-direction: column; align-items: center; padding-top: 20px; box-sizing: border-box; }
        .question-text { font-size: 1.5rem; margin-bottom: 20px; text-align: center; max-width: 80%; }
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%; }
        .option-btn { background: #334155; color: white; border: 2px solid #475569; padding: 15px; cursor: pointer; font-size: 1.1rem; border-radius: 8px; transition: 0.2s; text-align: left; }
        .option-btn:hover { background: #475569; border-color: var(--primary); }
        
        /* Hi·ªáu ·ª©ng & Loading */
        .hidden { display: none !important; }
        .damage-text { position: absolute; font-size: 3rem; font-weight: bold; color: yellow; animation: floatUp 1s forwards; pointer-events: none; z-index: 20; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        
        .attack-anim { animation: lunge 0.3s alternate 2; }
        @keyframes lunge { 0% { transform: translateX(0); } 100% { transform: translateX(50px); } } /* Hero lunge */
        .attack-anim-m { animation: lungeM 0.3s alternate 2; }
        @keyframes lungeM { 0% { transform: translateX(0); } 100% { transform: translateX(-50px); } } /* Monster lunge */

        /* Loading Spinner */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="game-container">
    <div class="overlay"></div>

    <div id="setup-screen">
        <h1 style="font-size: 3rem; color: var(--primary); text-shadow: 0 0 10px white;">‚öîÔ∏è MATH SURVIVOR</h1>
        
        <label style="display:none">1. Nh·∫≠p API Key Gemini (B·∫Øt bu·ªôc):</label>
        <input type="password" id="api-key" placeholder="D√°n key AIza... v√†o ƒë√¢y">
        
        <label>2. Ch·ªçn ch·ªß ƒë·ªÅ:</label>
        <select id="topic">
            <option value="addition_fractions">C·ªông tr·ª´ ph√¢n th·ª©c ƒë·∫°i s·ªë</option>
            <option value="simplifying_fractions">R√∫t g·ªçn ph√¢n th·ª©c</option>
            <option value="equations">Gi·∫£i ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t</option>
        </select>

        <label>3. ƒê·ªô kh√≥ (S·ª©c m·∫°nh qu√°i v·∫≠t):</label>
        <select id="difficulty">
            <option value="Easy">D·ªÖ (Qu√°i v·∫≠t Blob)</option>
            <option value="Medium">Th∆∞·ªùng (R·ªìng l·ª≠a)</option>
            <option value="Hard">Kh√≥ (Ch√∫a t·ªÉ H·∫Øc √°m)</option>
        </select>

        <button class="btn-start" onclick="startGame()">V√ÄO TR·∫¨N ƒê·∫§U</button>
    </div>

    <div id="battle-screen">
        <div id="hero-hp-box" class="hp-container">
            <div style="font-weight: bold;">ü•∑ Hi·ªáp Sƒ© (B·∫°n)</div>
            <div class="hp-bar"><div id="hero-hp-fill" class="hp-fill"></div></div>
            <div id="hero-hp-text">100/100</div>
        </div>

        <div id="monster-hp-box" class="hp-container">
            <div style="font-weight: bold;" id="monster-name">Qu√°i V·∫≠t</div>
            <div class="hp-bar"><div id="monster-hp-fill" class="hp-fill"></div></div>
            <div id="monster-hp-text">100/100</div>
        </div>

        <div id="hero" class="character">ü•∑</div>
        <div id="monster" class="character">üêâ</div>

        <div class="combat-ui">
            <div id="loading-box" class="hidden">
                <div class="loader"></div>
                <div>Qu√°i v·∫≠t ƒëang ni·ªám ch√∫ (T·∫°o c√¢u h·ªèi)...</div>
            </div>
            
            <div id="question-area">
                <div id="question-text" class="question-text">ƒêang t·∫£i...</div>
                <div id="options-area" class="options-container">
                    </div>
            </div>
            
            <div id="message-area" style="color: yellow; font-weight: bold; font-size: 1.2rem; margin-top: 10px;"></div>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let gameState = {
        apiKey: 'AIzaSyB8NLibfH2L-mjDfZ-bpsMJ2Ju9Yk355iE',
        topic: '',
        difficulty: '',
        heroHP: 100,
        monsterHP: 100,
        monsterMaxHP: 100,
        currentQuestion: null
    };

    const monsters = {
        'Easy': { icon: 'ü¶†', name: 'Slime Nh·∫ßy Nh·ª•a', hp: 50, dmg: 10 },
        'Medium': { icon: 'üêâ', name: 'R·ªìng L·ª≠a', hp: 100, dmg: 20 },
        'Hard': { icon: 'üëπ', name: 'Qu·ª∑ V∆∞∆°ng', hp: 200, dmg: 30 }
    };

    // --- GAME LOGIC ---

    function startGame() {
        // N·∫øu ch∆∞a c√≥ key trong gameState th√¨ m·ªõi l·∫•y t·ª´ √¥ input
        if (!gameState.apiKey) {
            const keyInput = document.getElementById('api-key').value;
            if (keyInput) {
                gameState.apiKey = keyInput;
            } else {
                alert("Vui l√≤ng nh·∫≠p API Key (ho·∫∑c d√°n c·ª©ng v√†o code) ƒë·ªÉ ch∆°i!"); 
                return;
            }
        }
        
        gameState.topic = document.getElementById('topic').value;
        gameState.difficulty = document.getElementById('difficulty').value;

        // Setup Monster Stats
        const monsterConfig = monsters[gameState.difficulty];
        gameState.monsterMaxHP = monsterConfig.hp;
        gameState.monsterHP = monsterConfig.hp;
        document.getElementById('monster').innerText = monsterConfig.icon;
        document.getElementById('monster-name').innerText = monsterConfig.name;

        // UI Transition
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('battle-screen').style.display = 'block';
        
        updateHPUI();
        loadNewTurn();
    }

    async function loadNewTurn() {
        // Show loading, hide question
        document.getElementById('loading-box').classList.remove('hidden');
        document.getElementById('question-area').classList.add('hidden');
        document.getElementById('message-area').innerText = "";

        try {
            await fetchQuestionFromGemini();
            // Show question, hide loading
            document.getElementById('loading-box').classList.add('hidden');
            document.getElementById('question-area').classList.remove('hidden');
            renderQuestion();
        } catch (e) {
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi AI. Vui l√≤ng ki·ªÉm tra API Key.");
            location.reload();
        }
    }

    async function fetchQuestionFromGemini() {
        const prompt = `
            Create a multiple-choice math question for 8th grade students.
            Topic: ${gameState.topic}. Difficulty: ${gameState.difficulty}.
            Language: Vietnamese.
            Output JSON ONLY: { "question": "LaTeX string in $$", "options": ["A", "B", "C", "D"], "correctIndex": 0 }
        `;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${gameState.apiKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

        const data = await response.json();
        let text = data.candidates[0].content.parts[0].text;
        // Clean JSON
        text = text.replace(/```json/g, "").replace(/```/g, "").trim();
        gameState.currentQuestion = JSON.parse(text);
    }

    function renderQuestion() {
        const q = gameState.currentQuestion;
        document.getElementById('question-text').innerHTML = q.question;
        
        const optsDiv = document.getElementById('options-area');
        optsDiv.innerHTML = '';
        
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerHTML = opt;
            btn.onclick = () => handleAnswer(idx);
            optsDiv.appendChild(btn);
        });

        MathJax.typesetPromise();
    }

    function handleAnswer(selectedIndex) {
        // Disable buttons
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.style.pointerEvents = 'none');

        const isCorrect = selectedIndex === gameState.currentQuestion.correctIndex;

        if (isCorrect) {
            btns[selectedIndex].style.background = 'var(--success)';
            performAttack('Hero');
        } else {
            btns[selectedIndex].style.background = 'var(--danger)';
            btns[gameState.currentQuestion.correctIndex].style.background = 'var(--success)'; // Show correct
            performAttack('Monster');
        }
    }

    function performAttack(attacker) {
        if (attacker === 'Hero') {
            // Hero attacks
            document.getElementById('hero').classList.add('attack-anim');
            setTimeout(() => {
                const dmg = 25; // Hero dmg
                gameState.monsterHP = Math.max(0, gameState.monsterHP - dmg);
                showDamage(dmg, 'monster');
                document.getElementById('hero').classList.remove('attack-anim');
                document.getElementById('monster').classList.add('shake'); // Monster hurt
                
                checkWinCondition();
            }, 300);
        } else {
            // Monster attacks
            document.getElementById('monster').classList.add('attack-anim-m');
            setTimeout(() => {
                const dmg = monsters[gameState.difficulty].dmg;
                gameState.heroHP = Math.max(0, gameState.heroHP - dmg);
                showDamage(dmg, 'hero');
                document.getElementById('monster').classList.remove('attack-anim-m');
                document.getElementById('hero').classList.add('shake'); // Hero hurt
                
                checkWinCondition();
            }, 300);
        }
    }

    function checkWinCondition() {
        updateHPUI();
        setTimeout(() => {
            document.getElementById('monster').classList.remove('shake');
            document.getElementById('hero').classList.remove('shake');

            if (gameState.monsterHP <= 0) {
                alert("CHI·∫æN TH·∫ÆNG! B·∫°n ƒë√£ ti√™u di·ªát qu√°i v·∫≠t! üèÜ");
                location.reload();
            } else if (gameState.heroHP <= 0) {
                alert("TH·∫§T B·∫†I! B·∫°n ƒë√£ g·ª•c ng√£... üíÄ");
                location.reload();
            } else {
                // Next Turn
                setTimeout(loadNewTurn, 1500);
            }
        }, 500);
    }

    function updateHPUI() {
        const hPct = (gameState.heroHP / 100) * 100;
        const mPct = (gameState.monsterHP / gameState.monsterMaxHP) * 100;

        document.getElementById('hero-hp-fill').style.width = `${hPct}%`;
        document.getElementById('hero-hp-text').innerText = `${gameState.heroHP}/100`;

        document.getElementById('monster-hp-fill').style.width = `${mPct}%`;
        document.getElementById('monster-hp-text').innerText = `${gameState.monsterHP}/${gameState.monsterMaxHP}`;
    }

    function showDamage(amount, targetId) {
        const el = document.createElement('div');
        el.className = 'damage-text';
        el.innerText = `-${amount}`;
        const target = document.getElementById(targetId);
        const rect = target.getBoundingClientRect();
        
        el.style.left = (rect.left + 50) + 'px';
        el.style.top = (rect.top) + 'px';
        el.style.color = targetId === 'hero' ? 'red' : 'yellow';

        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }
</script>
</body>
</html>
